

use Sales
go

create table PRODUCT_DIMENSION(PRODUCT_SK INT PRIMARY KEY,
PRODUCT_CODE INT UNIQUE,PRODUCT_DESCRIPTION VARCHAR(30),PRODUCT_CATAGORY VARCHAR(30));


create table TIME_DIMENSION(TIME_SK INT PRIMARY KEY,
WEEK INT,MONTH VARCHAR(5),QUARTER VARCHAR(3),YEAR INT);

create table CUSTOMER_DIMENSION(CUSTOMER_SK INT PRIMARY KEY,
CUSTOMER_ID INT UNIQUE,CUSTOMER_NAME VARCHAR(30),CUSTOMER_LOCATION VARCHAR(30));

create table STORE_DIMENSION(STORE_SK INT PRIMARY KEY,
STORE_CODE INT UNIQUE,STATE VARCHAR(30),REGION VARCHAR(30));

create table SALES_FACT
(CUSTOMER_SK INT REFERENCES CUSTOMER_DIMENSION(CUSTOMER_SK),
PRODUCT_SK INT REFERENCES PRODUCT_DIMENSION(PRODUCT_SK),
STORE_SK INT REFERENCES STORE_DIMENSION(STORE_SK),
TIME_SK INT REFERENCES TIME_DIMENSION(TIME_SK),
SALES_AMOUNT INT);


--1)WEEKLY SALES BY PRODUCT CATAGORY

SELECT SALES_AMOUNT,TIME_DIMENSION.WEEK,PRODUCT_DIMENSION.PRODUCT_CATAGORY FROM SALES_FACT 
JOIN PRODUCT_DIMENSION ON PRODUCT_DIMENSION.PRODUCT_SK=SALES_FACT.PRODUCT_SK
JOIN TIME_DIMENSION ON TIME_DIMENSION.TIME_SK=SALES_FACT.TIME_SK
GROUP BY TIME_DIMENSION.WEEK,PRODUCT_DIMENSION.PRODUCT_CATAGORY;

--2)TOTAL NO. OF CUSTOMERS BY REGION WHO HAVE PURCHASED MORE THAN 20000 IN CALENDAR YEAR
SELECT STORE_DIMENSION.REGION,TIME_DIMENSION.YEAR,COUNT(CUSTOMER_DIMENSION.CUSTOMER_ID) FROM CUSTOMER_DIMENSION
JOIN SALES_FACT ON SALES_FACT.CUSTOMER_SK=CUSTOMER_DIMENSION.CUSTOMER_SK
JOIN TIME_DIMENSION ON SALES_FACT.TIME_SK=TIME_DIMENSION.TIME_SK
JOIN STORE_DIMENSION ON SALES_FACT.STORE_SK=STORE_DIMENSION.STORE_SK
WHERE SALES_FACT.SALES_AMOUNT>20000 
GROUP BY STORE_DIMENSION.REGION,TIME_DIMENSION.YEAR;

--4)LIST THE DUPLICATE RECORDS BY PRODUCT CODE, PRODUCR DESCRIPTION

A) Select PRODUCT_DIMENSION.PRODUCT_CODE,PRODUCT_DIMENSION.PRODUCT_DESCRIPTION FROM PRODUCT_DIMENSION
WHERE PRODUCT_DIMENSION.PRODUCT_SK NOT IN 
(SELECT MAX(PRODUCT_DIMENSION.PRODUCT_SK)
	FROM PRODUCT_DIMENSION
	GROUP BY PRODUCT_DIMENSION.PRODUCT_CODE,PRODUCT_DIMENSION.PRODUCT_DESCRIPTION);

B) Select PRODUCT_DIMENSION.PRODUCT_CODE,PRODUCT_DIMENSION.PRODUCT_DESCRIPTION FROM PRODUCT_DIMENSION
GROUP BY PRODUCT_DIMENSION.PRODUCT_CODE,PRODUCT_DIMENSION.PRODUCT_DESCRIPTION
Having COUNT(PRODUCT_DIMENSION.PRODUCT_CODE) > 1 AND COUNT(PRODUCT_DIMENSION.PRODUCT_DESCRIPTION) > 1;

--5)DELETE THE DUPLICATE RECORDS BY PRODUCT CODE, PRODUCR DESCRIPTION
DELETE FROM PRODUCT_DIMENSION
WHERE PRODUCT_DIMENSION.PRODUCT_SK NOT IN 
(SELECT MAX(PRODUCT_DIMENSION.PRODUCT_SK)
	FROM PRODUCT_DIMENSION
	GROUP BY PRODUCT_DIMENSION.PRODUCT_CODE,PRODUCT_DIMENSION.PRODUCT_DESCRIPTION);

--6)FETCH  CUSTOMERS WHO HAVE NOT PURCHASED A SINGLE ITEM USING CORRETALED SUBQUERY

SELECT CUSTOMER_DIMENSION.CUSTOMER_ID FROM CUSTOMER_DIMENSION
JOIN SALES_FACT ON SALES_FACT.CUSTOMER_SK=CUSTOMER_DIMENSION.CUSTOMER_SK
JOIN PRODUCT_DIMENSION ON SALES_FACT.PRODUCT_SK=PRODUCT_DIMENSION.PRODUCT_SK
WHERE PRODUCT_DIMENSION.PRODUCT_CODE NOT IN( SELECT PRODUCT_DIMENSION.PRODUCT_CODE FROM PRODUCT_DIMENSION);